<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <p>
        Tasks:<br/>
        1. Create a firebase account<br/>
        2. Add base data of order table to firebase <br/>
        3. Plan schema while doing so<br/><br/>
        Queries to make:<br/>   
        1. Add new order to firebase made by one of the existing people<br/>
        2. Get order by personId<br/>
        3. Get all Orders<br/>
        4.  Get orders where number of boots purchase is greater than 3<br/>
        5. Get all orders where only one type of boot is purchased<br/>
    </p>
    <input type="text" id='input' placeholder="Enter Person ID">
    <button type="button" onclick='getOrdersOfPerson()' id="done-button">Get Orders</button>
    <div id="test">

    </div>

    <!-- Firebase App is always required and must be first -->
    <script src="https://www.gstatic.com/firebasejs/5.4.0/firebase-app.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <!-- Add additional services that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.0/firebase-functions.js"></script>

    <!-- Comment out (or don't include) services that you don't want to use -->
    <!-- <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-storage.js"></script> -->
    <script src="xml_helper.js"></script>
    <script>
        let boot = [];
        let person = [];
        var config = {
            apiKey: "AIzaSyA6rgyF62FhuV--3T3H0uREeSL8YrDJIAA",
            authDomain: "ads-orders.firebaseapp.com",
            databaseURL: "https://ads-orders.firebaseio.com",
            projectId: "ads-orders",
            storageBucket: "ads-orders.appspot.com",
            messagingSenderId: "949999655001"
        };
        firebase.initializeApp(config);
        var database = firebase.database();

        function writeUserData(orderId, boots, personId) {
            firebase.database().ref().push({
                id: orderId,
                time: new Date().toISOString(),
                boots,
                personId
            });
            console.log('Order is added');
        }

        function getOrderById(orderId) {
            firebase.database().ref().orderByChild("id").equalTo(orderId).once('value').then((data) => {
                console.log(data.val());
            });
        }

        function getOrdersOfPerson(personId) {
            myOrders = [];
            elem = document.getElementById('test');
            elem.innerHTML = "";
            firebase.database().ref().orderByChild("personId").equalTo(document.getElementById('input').value).on(
                'value', (data) => {
                    x = data.val();
                    console.log(x);
                    if (x === null) {
                        elem.innerHTML = "No such person!!";
                    } else {
                        total = 0;
                        for (key in x) {
                            element = x[key];
                            elem.innerHTML +=
                                `OrderID:${element.id}\tPerson Data:${JSON.stringify(person[element.personId])}<br/>`;
                            for (k1 in x[key].boots) {
                                b = x[key].boots[k1];
                                console.log(b);
                                total += boot[b.id].cost * b.quantity;
                                elem.innerHTML +=
                                    `&nbsp;&nbsp;&nbsp;&nbsp;Name:${boot[b.id].name}    Description:${boot[b.id].description}   Cost:${boot[b.id].cost*b.quantity}<br/>`;
                            }
                        }
                        elem.innerHTML += `<br/>Total:${total}`;

                    }
                });

        }

        function getAllOrderData() {
            firebase.database().ref().once('value').then((data) => {
                console.log(data.val());
            });
        }

        const loadPersonAndBootData =()=>{
            find('person_store.xml', '//x:person')
            .then((data) => {
                console.log("Data recieved:", data);
                for (let i = 0; i < data.length; i++) {
                    id = data[i].children[0].firstChild.data;
                    e = data[i].children[1].firstChild.data;
                    name = data[i].children[2].firstChild.data;
                    person[id] = {
                        email: e,
                        name
                    };
                }
            }).catch(console.log);
        find('boot_store.xml', '//x:boot')
            .then((data) => {
                console.log("Data recieved:", data);
                for (let i = 0; i < data.length; i++) {
                    id = data[i].children[0].firstChild.data;
                    name = data[i].children[1].firstChild.data;
                    description = data[i].children[2].firstChild.data;
                    cost = data[i].children[3].firstChild.data;
                    boot[id] = {
                        description,
                        cost,
                        name
                    };
                }
            }).catch(console.log);

        }
        loadPersonAndBootData();
    </script>
</body>

</html>